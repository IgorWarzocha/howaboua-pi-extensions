{
  "id": "069c729f",
  "title": "[Phase 2] PI-TODOS: Add checklist support",
  "tags": [],
  "status": "done",
  "created_at": "2026-02-12T00:22:47.748Z"
}

Enhance pi-todos extension to support checklists. Model MUST tick items one-by-one to complete todos.

## Files to Modify
- `types.ts` - Add ChecklistItem interface, extend TodoFrontMatter/TodoRecord
- `parser.ts` - Parse/serialize checklist in frontmatter
- `format.ts` - Format checklist for display, progress indicators, tool return formatting
- `tool.ts` - Add `tick` action, modify `update` to prevent manual "done" status when checklist exists
- `tui/selector.ts` - Show progress indicator in todo line
- `tui/detail-overlay.ts` - Render checklist with edit flow

## Data Model Changes

### ChecklistItem Interface
```typescript
interface ChecklistItem {
  id: string;                     // Short hex ID (e.g., "1", "2a", "3b")
  title: string;
  status: "unchecked" | "checked";
}
```

### TodoFrontMatter Extension
```typescript
interface TodoFrontMatter {
  // ... existing fields
  checklist?: ChecklistItem[];    // Optional, enables checklist workflow
}
```

Note: TodoRecord extends TodoFrontMatter, so inherits checklist field.

## Implementation Steps

### 1. Parser/Serializer Updates
- Extend `parseFrontMatter()` to handle `checklist` array
- Extend `serializeTodo()` to output checklist
- Validate checklist item structure, return clear error if malformed
- Maintain backwards compatibility (checklist is optional field)

### 2. Status Derivation (Automatic)
Status MUST be automatically derived from checklist completion:

```typescript
function deriveTodoStatus(todo: TodoRecord): string {
  if (!todo.checklist?.length) return todo.status;  // No checklist = use manual status
  const checked = todo.checklist.filter(i => i.status === "checked").length;
  if (checked === 0) return "open";
  if (checked === todo.checklist.length) return "done";
  return "in-progress";
}
```

**Important**: When a todo has a checklist:
- Model MUST tick all items to mark todo as done
- `update` action with `status: "done"` MUST be rejected with error explaining to use `tick` instead
- Status is read-only, derived from checklist state

### 3. Tool Action: `tick`

Add new `tick` action to todo tool:

```typescript
// In TodoParams
action: StringEnum([
  "list", "list-all", "get", "create", "update", "append",
  "delete", "claim", "release",
  "tick",  // NEW
] as const),

// New parameter (only for tick action)
item: Type.Optional(Type.String({ description: "Checklist item id to tick (required for tick action)" })),
```

**Behavior:**
- Accepts exactly one item id (schema enforced)
- Toggles item status: unchecked → checked, checked → unchecked
- Updates todo status based on derivation logic
- Returns remaining unchecked items with continuation prompt

**Tool Return Format:**
```
Ticked item 1 "Add JWT middleware".

Remaining in TODO-abc123 "Implement auth feature":
  [ ] Define auth flow
  [ ] Write tests

Continue working through the remaining items.
```

**When all items ticked:**
```
Ticked item 5 "Write tests". All items complete!

TODO-abc123 "Implement auth feature" is now done.
```

### 4. TUI Updates

#### Selector (tui/selector.ts)
- Show progress indicator in todo title line: `TODO-abc123 Title (2/5)`
- Format: `(checked/total)` shown after status badge

#### Detail Overlay (tui/detail-overlay.ts)
- Render checklist with checkboxes at top of body
- Show progress: "Progress: 2/5 items complete"
- Display-only, NO user toggling in TUI
- Edit flow: User presses Enter on checklist → input field → user types intent → sent to agent with current checklist → agent reworks via `update`

#### Visual Format
```
─── Implement auth feature ───
TODO-abc123 • in-progress • auth, security
Progress: 3/5 items complete

[x] Add JWT middleware
[x] Create login endpoint
[x] Write tests
[ ] Define auth flow
[ ] Add refresh token logic

(body content follows...)

enter edit checklist • esc back
```

### 5. Edit Flow (Agent-Mediated)

When user wants to modify checklist:
1. User highlights checklist section in detail overlay
2. User presses Enter
3. Input field appears: "What would you like to do with the checklist?"
4. User types intent (e.g., "add testing tasks", "remove the auth flow item")
5. Prompt + current checklist sent to agent via `pi.sendUserMessage()`
6. Agent uses `update` action to modify checklist array

This mirrors the existing "refine" flow for todo content.

## Acceptance Criteria
- [ ] ChecklistItem interface added with id, title, status fields only
- [ ] Checklist stored in frontmatter (optional field)
- [ ] `tick` action added, accepts single item id
- [ ] `tick` returns remaining unchecked items + continuation prompt
- [ ] Status automatically derived when checklist exists
- [ ] `update` action rejects `status: "done"` when checklist exists
- [ ] Progress indicator shown in selector (2/5 format)
- [ ] Checklist rendered in detail overlay with checkboxes
- [ ] Edit flow sends to agent (no direct TUI editing)
- [ ] Backwards compatible with existing todos (no checklist = no behavior change)
